<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap-to-Tune Music Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }

        .container {
            background-color: #2d3748; /* Slightly lighter dark background for container */
            border-radius: 1rem; /* Rounded corners */
            padding: 2rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #tapBar {
            width: 100%;
            height: 150px;
            background-color: #4a5568; /* Greyish blue */
            border-radius: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none; /* Prevent text selection on tap */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid #636b77;
        }

        #tapBar:active {
            background-color: #636b77; /* Darker on active */
            transform: scale(0.98); /* Slight press effect */
        }

        .button-group {
            display: flex;
            gap: 1rem; /* Space between buttons */
            margin-top: 1.5rem;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center;
        }

        .action-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .action-button:active {
            transform: translateY(1px); /* Slight press effect */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #playButton {
            background-color: #48bb78; /* Green */
            color: white;
        }

        #playButton:hover {
            background-color: #38a169; /* Darker green on hover */
        }

        #clearButton {
            background-color: #fc8181; /* Red */
            color: white;
        }

        #clearButton:hover {
            background-color: #e53e3e; /* Darker red on hover */
        }

        #messageBox {
            margin-top: 1.5rem;
            padding: 0.75rem 1rem;
            background-color: #3f51b5; /* Blue for messages */
            color: white;
            border-radius: 0.5rem;
            text-align: center;
            min-height: 2.5rem; /* Ensure it has some height even when empty */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 400px;
            opacity: 0; /* Initially hidden */
            transition: opacity 0.3s ease-in-out;
        }

        #messageBox.show {
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem;
            }
            #tapBar {
                height: 120px;
                font-size: 1.25rem;
            }
            .button-group {
                flex-direction: column;
                gap: 0.75rem;
            }
            .action-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
     <a href="index.html">
    <button class="mt-4 mb-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700 transition">
      ‚Üê Back to Home
    </button>
  </a>
    <div class="container">
        <h1 class="text-3xl font-bold mb-6 text-center">Tap-to-Tune</h1>

        <div id="tapBar" class="mb-4">
            Tap here to make music!
        </div>

        <div class="button-group">
            <button id="playButton" class="action-button">Play Sequence</button>
            <button id="clearButton" class="action-button">Clear Sequence</button>
        </div>

        <div id="messageBox"></div>
    </div>

    <script>
        // Ensure Tone.js is loaded before proceeding
        if (typeof Tone === 'undefined') {
            console.error("Tone.js is not loaded. Please check the CDN link.");
        }

        // Initialize Tone.js components
        let synth; // Our synthesizer
        let recordedSequence = []; // Stores objects like { note: 'C4', time: 0.5 }
        let startTime = 0; // To keep track of the start time of recording

        // DOM elements
        const tapBar = document.getElementById('tapBar');
        const playButton = document.getElementById('playButton');
        const clearButton = document.getElementById('clearButton');
        const messageBox = document.getElementById('messageBox');

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {number} duration - How long to show the message in milliseconds.
         */
        function showMessage(message, duration = 2000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        /**
         * Initializes the audio context and synthesizer.
         * This function is called on the first user interaction to comply with browser autoplay policies.
         */
        async function initializeAudio() {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log('Audio context started');
            }

            // Create a simple polyphonic synthesizer
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: {
                    type: "sine" // A smooth sine wave
                },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 1
                }
            }).toDestination(); // Connect to the speakers
            console.log('Synthesizer initialized');
        }

        /**
         * Generates a random musical note.
         * @returns {string} A note string (e.g., 'C4', 'D#3').
         */
        function getRandomNote() {
            const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const accidentals = ['', '#', 'b']; // Natural, sharp, flat
            const octaves = [3, 4, 5]; // Common musical octaves

            const randomNote = notes[Math.floor(Math.random() * notes.length)];
            const randomAccidental = accidentals[Math.floor(Math.random() * accidentals.length)];
            const randomOctave = octaves[Math.floor(Math.random() * octaves.length)];

            return `${randomNote}${randomAccidental}${randomOctave}`;
        }

        /**
         * Handles the tap event on the bar.
         * Plays a random note and records it.
         */
        async function handleTap() {
            // Initialize audio on first tap
            if (!synth) {
                await initializeAudio();
            }

            // If this is the first tap, set the recording start time
            if (recordedSequence.length === 0) {
                startTime = Tone.now();
                showMessage("Recording started!");
            }

            const note = getRandomNote();
            const tapTime = Tone.now();
            const relativeTime = tapTime - startTime; // Time relative to the start of recording

            // Play the note immediately
            synth.triggerAttackRelease(note, '8n'); // Play for an 8th note duration

            // Record the note and its relative time
            recordedSequence.push({ note: note, time: relativeTime });
            console.log(`Tapped: ${note} at relative time: ${relativeTime.toFixed(2)}s`);
            showMessage(`Note: ${note}`);
        }

        /**
         * Handles the play button click.
         * Plays back the recorded sequence.
         */
        async function handlePlay() {
            if (!synth) {
                showMessage("Tap the bar first to record a sequence!");
                return;
            }

            if (recordedSequence.length === 0) {
                showMessage("No sequence recorded. Tap the bar to create one!");
                return;
            }

            showMessage("Playing sequence...");
            console.log("Playing sequence:", recordedSequence);

            // Stop any ongoing playback
            Tone.Transport.stop();
            Tone.Transport.cancel(); // Clear all scheduled events

            // Schedule each note in the sequence
            recordedSequence.forEach(item => {
                Tone.Transport.scheduleOnce(() => {
                    synth.triggerAttackRelease(item.note, '8n');
                    console.log(`Playing: ${item.note} at Transport time: ${Tone.Transport.seconds.toFixed(2)}s`);
                }, item.time);
            });

            // Start the transport
            Tone.Transport.start();

            // Optional: Show message when playback finishes
            const totalDuration = recordedSequence.reduce((max, item) => Math.max(max, item.time), 0) + 1; // Add a bit for release
            setTimeout(() => {
                showMessage("Playback finished.");
            }, totalDuration * 1000); // Convert Tone.js seconds to milliseconds
        }

        /**
         * Handles the clear button click.
         * Clears the recorded sequence and resets the start time.
         */
        function handleClear() {
            recordedSequence = [];
            startTime = 0;
            Tone.Transport.stop();
            Tone.Transport.cancel();
            showMessage("Sequence cleared!");
            console.log("Sequence cleared.");
        }

        // Event Listeners for tap and buttons
        tapBar.addEventListener('click', handleTap);
        playButton.addEventListener('click', handlePlay);
        clearButton.addEventListener('click', handleClear);

        // Add touch event listeners for mobile devices
        tapBar.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling/zooming
            handleTap();
        });
        playButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handlePlay();
        });
        clearButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleClear();
        });

        // Initial message
        window.onload = () => {
            showMessage("Tap the bar to start recording your tune!");
        };

    </script>
</body>
</html>